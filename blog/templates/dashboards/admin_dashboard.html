{% extends "base.html" %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<main>
    <div id="admin-welcome">
        <h2 class="mb-4">
            Welcome, {{ user.user.first_name|default:user.user.username }} ðŸ‘‹
        </h2>
    </div>

    <!-- CLIENTS AND AVAILABILITIES -->
    <div id="admin-section-clients">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Clients / Availabilities</h5>
            </div>
            <div class="card-body">
                {% if clients %}
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Email</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in clients %}
                        <tr>
                            <td>{{ client.user.first_name }} {{ client.user.last_name }}</td>
                            <td>{{ client.user.email }}</td>
                            <td>{{ client.location }}</td>
                            <td>
                                <a href="{% url 'view_client_availabilities' client.user.id %}" class="btn btn-sm btn-info">View Availabilities</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No clients added yet.</p>
                {% endif %}

                <div class="mt-3">
                    <h6>Add New Client</h6>
                    <form id="add-client-form">
                        {% csrf_token %}
                        <input type="text" name="first_name" placeholder="First Name" required>
                        <input type="text" name="last_name" placeholder="Last Name" required>
                        <input type="email" name="email" placeholder="Email" required>
                        <input type="text" name="location" placeholder="Location">
                        <button type="submit" class="btn btn-primary btn-sm">Add Client</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- STAFF AND TIME OFF REQUESTS -->
    <div id="admin-section-staff">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Staff / Time Off Requests</h5>
            </div>
            <div class="card-body">
                {% if staff %}
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in staff %}
                        <tr>
                            <td>{{ member.user.first_name }} {{ member.user.last_name }}</td>
                            <td>{{ member.user.email }}</td>
                            <td>
                                <a href="{% url 'view_staff_timeoff' member.user.id %}" class="btn btn-sm btn-info">View Time Offs</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No staff added yet.</p>
                {% endif %}

                <div class="mt-3">
                    <h6>Add New Staff</h6>
                    <form id="add-staff-form">
                        {% csrf_token %}
                        <input type="text" name="first_name" placeholder="First Name" required>
                        <input type="text" name="last_name" placeholder="Last Name" required>
                        <input type="email" name="email" placeholder="Email" required>
                        <button type="submit" class="btn btn-primary btn-sm">Add Staff</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- BOOKINGS MANAGEMENT -->
    <div id="admin-section-bookings">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Bookings</h5>
            </div>
            <div class="card-body">
                {% if bookings %}
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Staff</th>
                            <th>Availability</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>{{ booking.customer.first_name }} {{ booking.customer.last_name }}</td>
                            <td>{{ booking.employee.first_name }} {{ booking.employee.last_name }}</td>
                            <td>{{ booking.availability.start_date }} - {{ booking.availability.end_date }}</td>
                            <td>{{ booking.status }}</td>
                            <td>
                                <a href="{% url 'edit_booking' booking.id %}" class="btn btn-sm btn-warning">Edit</a>
                                <form method="POST" action="{% url 'delete_booking' booking.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No bookings yet.</p>
                {% endif %}

                <div class="mt-3">
                    <h6>Add New Booking</h6>
                    <form id="add-booking-form">
                        {% csrf_token %}
                        <select name="client" required>
                            <option value="">Select Client</option>
                            {% for client in clients %}
                            <option value="{{ client.user.id }}">{{ client.user.first_name }} {{ client.user.last_name }}</option>
                            {% endfor %}
                        </select>
                        <select name="staff" required>
                            <option value="">Select Staff</option>
                            {% for member in staff %}
                            <option value="{{ member.user.id }}">{{ member.user.first_name }} {{ member.user.last_name }}</option>
                            {% endfor %}
                        </select>
                        <select name="availability" required>
                            <option value="">Select Availability</option>
                            {% for avail in availabilities %}
                            <option value="{{ avail.id }}">{{ avail.customer.first_name }}: {{ avail.start_date }} - {{ avail.end_date }}</option>
                            {% endfor %}
                        </select>
                        <select name="status" required>
                            <option value="OPEN">Open</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm">Add Booking</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Button -->
    <a href="{% url 'logout' %}" id="btnLogin2">Logout</a>
</main>

<!-- AJAX Scripts -->
<script>
    // Add Client
    document.getElementById("add-client-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const response = await fetch("{% url 'add_client' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        });
        const data = await response.json();
        alert(data.message);
        if (data.success) location.reload();
    });

    // Add Staff
    document.getElementById("add-staff-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const response = await fetch("{% url 'add_staff' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        });
        const data = await response.json();
        alert(data.message);
        if (data.success) location.reload();
    });

    // Add Booking
    document.getElementById("add-booking-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const response = await fetch("{% url 'add_booking' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        });
        const data = await response.json();
        alert(data.message);
        if (data.success) location.reload();
    });
</script>
{% endblock %}
