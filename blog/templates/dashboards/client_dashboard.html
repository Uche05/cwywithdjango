{% extends "base.html" %}
{% load static %}

{% block title %}Client Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2 class="dashboard-heading">Welcome, {{ user.user.first_name|default:user.user.username }} ðŸ‘‹</h2>

    <!-- AVAILABILITIES -->
    <div class="card">
        <div class="card-header">
            <h5>Your Availabilities</h5>
        </div>
        <div class="card-body">
            <table class="dashboard-table" id="availabilitiesTable">
                <thead>
                    <tr>
                        <th>Start</th>
                        <th>End</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for availability in availabilities %}
                    <tr data-id="{{ availability.id }}">
                        <td>{{ availability.start_date }}</td>
                        <td>{{ availability.end_date }}</td>
                        <td>{{ availability.status }}</td>
                        <td>
                            <button class="btn-delete" data-id="{{ availability.id }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not availabilities %}
                <p>No availabilities added yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- ADD NEW AVAILABILITY -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>Add New Availability</h5>
        </div>
        <div class="card-body">
            <form id="availability-form">
                {% csrf_token %}
                <div class="form-group mb-3">
                    <label for="start_date">Start Date & Time</label>
                    <input type="datetime-local" class="form-control" name="start_date" required>
                </div>
                <div class="form-group mb-3">
                    <label for="end_date">End Date & Time</label>
                    <input type="datetime-local" class="form-control" name="end_date" required>
                </div>
                <div class="form-group mb-3">
                    <label for="status">Status</label>
                    <select class="form-control" name="status">
                        <option value="OPEN">Open</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100">Add Availability</button>
            </form>
        </div>
    </div>

    <!-- Logout Button -->
    <a href="{% url 'logout' %}" id="btnLogin2">Logout</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("availability-form");
    const tableBody = document.querySelector("#availabilitiesTable tbody");

    // Add new availability
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const response = await fetch("{% url 'add_availability' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.error) {
            alert(result.error);
            return;
        }

        // Add new row to table
        const tr = document.createElement("tr");
        tr.setAttribute("data-id", result.id);
        tr.innerHTML = `
            <td>${result.start_date}</td>
            <td>${result.end_date}</td>
            <td>${result.status}</td>
            <td>
                <button class="btn-delete" data-id="${result.id}">Delete</button>
            </td>
        `;
        tableBody.appendChild(tr);

        // Clear form
        form.reset();
    });

    // Delete availability (delegated)
    tableBody.addEventListener("click", async (e) => {
        if (!e.target.classList.contains("btn-delete")) return;

        const id = e.target.dataset.id;
        const confirmed = confirm("Are you sure you want to delete this availability?");
        if (!confirmed) return;

        const response = await fetch(`/availability/delete/${id}/`, {
            method: "DELETE",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        });

        const result = await response.json();
        if (result.success) {
            // Remove row from table
            const row = tableBody.querySelector(`tr[data-id="${id}"]`);
            if (row) row.remove();
        } else {
            alert(result.error || "Failed to delete availability");
        }
    });
});
</script>
{% endblock %}
